[ERROR] TypeError: string indices must be integers
Traceback (most recent call last):
  File "/var/task/lambda_function.py", line 46, in lambda_handler
    path = os.path.join(os.environ['s3FolderPath'], blob['path'])
    
    [ERROR] AttributeError: 'CodeCommit' object has no attribute 'get_object'
Traceback (most recent call last):
  File "/var/task/lambda_function.py", line 46, in lambda_handler
    blob_list = get_blob_list(codecommit, os.environ['repository'], last_commit_id)
  File "/var/task/lambda_function.py", line 16, in get_blob_list
    obj = codecommit.get_object(repositoryName=repository, objectId=blob['blobId'])
  File "/var/runtime/botocore/client.py", line 657, in __getattr__
    raise AttributeError(
    
    
[ERROR] NoSuchKey: An error occurred (NoSuchKey) when calling the GetObject operation: The specified key does not exist.
Traceback (most recent call last):
  File "/var/task/lambda_function.py", line 48, in lambda_handler
    blob_list = get_blob_list(codecommit, s3, os.environ['repository'], last_commit_id)
  File "/var/task/lambda_function.py", line 16, in get_blob_list
    obj = s3.get_object(Bucket=os.environ['s3BucketName'], Key=blob['blobId'])
  File "/var/runtime/botocore/client.py", line 391, in _api_call
    return self._make_api_call(operation_name, kwargs)
  File "/var/runtime/botocore/client.py", line 719, in _make_api_call
    raise error_class(parsed_response, operation_name)


event {'Records': [{'awsRegion': 'ap-south-1', 'codecommit': {'references': [{'commit': '2fb2f2c65245e2d4505881e1691e525cfb5e8709', 'ref': 'refs/heads/master'}]}, 'customData': None, 'eventId': '4307be1b-546e-473c-b041-2eb04fa7318c', 'eventName': 'ReferenceChanges', 'eventPartNumber': 1, 'eventSource': 'aws:codecommit', 'eventSourceARN': 'arn:aws:codecommit:ap-south-1:728675747238:test-cicd', 'eventTime': '2023-02-16T06:25:55.077+0000', 'eventTotalParts': 1, 'eventTriggerConfigId': '28e57893-23d6-4f25-87c4-0b49059609c6', 'eventTriggerName': 'test', 'eventVersion': '1.0', 'userIdentityARN': 'arn:aws:iam::728675747238:user/p.shukla1@tcs.com'}]}
-----------------

import os
import boto3
import json

def lambda_handler(event, context):
    # Get the S3 client
    s3 = boto3.client('s3')
    
    # Get the bucket name from environment variable
    bucket_name = os.environ['bucketName']
    
    # Get the s3 folder path from environment variable
    folder_path = os.environ['s3FolderPath']

    # Get the last commit ID from the CodeCommit event
    last_commit_id = event['Records'][0]['codecommit']['references'][0]['commit']

    # Get the diff between the last two commits
    response = s3.list_objects_v2(Bucket=bucket_name, Prefix=folder_path)
    existing_keys = [obj['Key'] for obj in response.get('Contents', [])]
    diff = s3.get_object(Bucket=bucket_name, Key=f"{folder_path}/{last_commit_id}.diff")['Body'].read().decode()
    blobs = diff.split('diff --git ')[1:]
    for blob in blobs:
        blob = blob.splitlines()[0].split()
        if blob[0] != 'a': # Skip files that are being deleted
            print("Blob: ", blob)
            path = os.path.join(folder_path, blob['path']) # Combine the folder path and file path
            if path not in existing_keys:
                s3.upload_file(Filename=blob['path'], Bucket=bucket_name, Key=path)
    return {
        'statusCode': 200,
        'body': json.dumps('S3 Upload Complete')
    }
---------------------------------------------------------

version: 0.2

phases:
  install:
    commands:
      - git config --global credential.helper '!aws codecommit credential-helper $@'
      - git config --global credential.UseHttpPath true
      # Install SnowSQL
      - curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.24-linux_x86_64.bash
      - bash snowsql-1.2.24-linux_x86_64.bash
      # Edit SnowSQL configuration file and add Snowflake user's username and password
      - echo -e '[connections]\naccountname = ll95421\nusername = tecodpp_dev_user\npassword = <replace_with_password>\n' >> ~/.snowsql/config

  build:
    commands:
      # Clone CodeCommit repository
      - git clone https://git-codecommit.ap-south-1.amazonaws.com/v1/repos/snowflake-test codecommit-repo

      # Execute SQL script
      - snowsql -a ll95421.ap-south-1.aws.snowflakecomputing.com -w ppg_teco_dpp_wh -r tecodpp_dev_role -s test_sc1 -f codecommit-repo/sql_script.sql
